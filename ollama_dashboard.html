<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .status-bar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .status-error {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #4a5568;
        }

        .metric-value {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.1rem;
        }

        .metric-value.high {
            color: #e53e3e;
        }

        .metric-value.medium {
            color: #d69e2e;
        }

        .metric-value.low {
            color: #38a169;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.low {
            background: #38a169;
        }

        .progress-fill.medium {
            background: #d69e2e;
        }

        .progress-fill.high {
            background: #e53e3e;
        }

        .models-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .model-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .model-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .model-usage {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .chart-container {
            height: 300px;
            margin-top: 1rem;
            position: relative;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
        }

        .chart-container::-webkit-scrollbar {
            width: 8px;
        }

        .chart-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .chart-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .chart-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .uptime-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Ollama Monitoring Dashboard</h1>
        <p>Real-time monitoring of Ollama service performance and usage</p>
    </div>

    <div class="container">
        <button class="refresh-btn" onclick="refreshAllData()">üîÑ Refresh Data</button>

        <!-- Status Bar -->
        <div class="status-bar">
            <div id="status-display">
                <div class="loading">Loading status...</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Performance Metrics -->
            <div class="card">
                <h2>‚ö° Performance</h2>
                <div id="performance-metrics">
                    <div class="loading">Loading performance metrics...</div>
                </div>
            </div>

            <!-- System Resources -->
            <div class="card">
                <h2>üíª System Resources</h2>
                <div id="system-resources">
                    <div class="loading">Loading system resources...</div>
                </div>
            </div>

            <!-- Usage Statistics -->
            <div class="card">
                <h2>üìä Usage Statistics</h2>
                <div id="usage-stats">
                    <div class="loading">Loading usage statistics...</div>
                </div>
            </div>

            <!-- Response Times -->
            <div class="card">
                <h2>‚è±Ô∏è Response Times</h2>
                <div id="response-times">
                    <div class="loading">Loading response times...</div>
                </div>
            </div>
        </div>

        <!-- Models Section -->
        <div class="models-section">
            <h2>ü§ñ Active Models</h2>
            <div id="models-display">
                <div class="loading">Loading models...</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h2>üìà CPU & Memory Usage</h2>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 1rem;">Real-time resource usage over time</p>
                <div class="chart-container" id="resource-chart">
                    <div class="loading">Loading chart...</div>
                </div>
            </div>

            <div class="chart-card">
                <h2>üìä Request History</h2>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 1rem;">Total requests over time</p>
                <div class="chart-container" id="request-chart">
                    <div class="loading">Loading chart...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let resourceData = [];
        let requestData = [];

        // Refresh all data
        async function refreshAllData() {
            await Promise.all([
                loadOllamaStatus(),
                loadRealtimeMetrics()
            ]);
        }

        // Load Ollama status
        async function loadOllamaStatus() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/ollama/status`);
                const data = await response.json();
                
                updateStatusDisplay(data);
                updatePerformanceMetrics(data);
                updateUsageStats(data);
                updateModelsDisplay(data);
                
            } catch (error) {
                console.error('Error loading Ollama status:', error);
                document.getElementById('status-display').innerHTML = 
                    `<div class="error-message">Error loading Ollama status: ${error.message}</div>`;
            }
        }

        // Load real-time metrics
        async function loadRealtimeMetrics() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/ollama/realtime`);
                const data = await response.json();
                
                updateSystemResources(data);
                updateResponseTimes(data);
                updateCharts(data);
                
            } catch (error) {
                console.error('Error loading real-time metrics:', error);
            }
        }

        // Update status display
        function updateStatusDisplay(data) {
            const statusDiv = document.getElementById('status-display');
            const status = data.current_status || 'unknown';
            
            let statusClass = 'status-error';
            let statusIcon = '‚ùå';
            
            if (status === 'running') {
                statusClass = 'status-running';
                statusIcon = '‚úÖ';
            } else if (status === 'stopped') {
                statusClass = 'status-stopped';
                statusIcon = '‚èπÔ∏è';
            }
            
            statusDiv.innerHTML = `
                <div class="status-indicator ${statusClass}">
                    ${statusIcon} Ollama Service: ${status.toUpperCase()}
                </div>
                <div class="uptime-display">
                    Uptime: ${data.uptime || 'Unknown'}
                </div>
            `;
        }

        // Update performance metrics
        function updatePerformanceMetrics(data) {
            const perfDiv = document.getElementById('performance-metrics');
            const perf = data.performance || {};
            
            perfDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Success Rate:</span>
                    <span class="metric-value ${getValueClass(perf.success_rate * 100, 80, 60)}">
                        ${((perf.success_rate || 0) * 100).toFixed(1)}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response Time:</span>
                    <span class="metric-value ${getValueClass(perf.avg_response_time, 5, 2)}">
                        ${(perf.avg_response_time || 0).toFixed(2)}s
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Requests:</span>
                    <span class="metric-value">${data.usage?.total_requests || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Error Count:</span>
                    <span class="metric-value ${data.usage?.error_count > 0 ? 'high' : 'low'}">
                        ${data.usage?.error_count || 0}
                    </span>
                </div>
            `;
        }

        // Update system resources
        function updateSystemResources(data) {
            const resourcesDiv = document.getElementById('system-resources');
            
            const cpuClass = getValueClass(data.cpu_percent, 80, 60);
            const memoryClass = getValueClass(data.memory_percent, 80, 60);
            
            resourcesDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">CPU Usage:</span>
                    <span class="metric-value ${cpuClass}">${data.cpu_percent?.toFixed(1) || 0}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${cpuClass}" style="width: ${data.cpu_percent || 0}%"></div>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Memory Usage:</span>
                    <span class="metric-value ${memoryClass}">${data.memory_percent?.toFixed(1) || 0}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${memoryClass}" style="width: ${data.memory_percent || 0}%"></div>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Memory Used:</span>
                    <span class="metric-value">${(data.memory_used_mb || 0).toFixed(1)} MB</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Disk Usage:</span>
                    <span class="metric-value">${(data.disk_usage_mb || 0).toFixed(1)} MB</span>
                </div>
            `;
        }

        // Update usage statistics
        function updateUsageStats(data) {
            const usageDiv = document.getElementById('usage-stats');
            const usage = data.usage || {};
            
            usageDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total Requests:</span>
                    <span class="metric-value">${usage.total_requests || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Success Rate:</span>
                    <span class="metric-value ${getValueClass(usage.success_rate * 100, 80, 60)}">
                        ${((usage.success_rate || 0) * 100).toFixed(1)}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Models:</span>
                    <span class="metric-value">${usage.active_models?.length || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Most Used Model:</span>
                    <span class="metric-value">${getMostUsedModel(usage.model_usage)}</span>
                </div>
            `;
        }

        // Update response times
        function updateResponseTimes(data) {
            const responseDiv = document.getElementById('response-times');
            
            responseDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Average Response:</span>
                    <span class="metric-value ${getValueClass(data.response_time_avg, 5, 2)}">
                        ${(data.response_time_avg || 0).toFixed(2)}s
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Request:</span>
                    <span class="metric-value">${data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'Never'}</span>
                </div>
            `;
        }

        // Update models display
        function updateModelsDisplay(data) {
            const modelsDiv = document.getElementById('models-display');
            const models = data.usage?.active_models || [];
            const modelUsage = data.usage?.model_usage || {};
            
            if (models.length === 0) {
                modelsDiv.innerHTML = '<div class="error-message">No active models found</div>';
                return;
            }
            
            let html = '<div class="models-grid">';
            models.forEach(model => {
                const usage = modelUsage[model] || 0;
                html += `
                    <div class="model-card">
                        <div class="model-name">${model}</div>
                        <div class="model-usage">${usage} requests</div>
                    </div>
                `;
            });
            html += '</div>';
            modelsDiv.innerHTML = html;
        }

        // Update charts
        function updateCharts(data) {
            // Add current data point
            const timestamp = new Date().toLocaleTimeString();
            resourceData.push({
                time: timestamp,
                cpu: data.cpu_percent || 0,
                memory: data.memory_percent || 0
            });
            
            requestData.push({
                time: timestamp,
                requests: data.total_requests || 0
            });
            
            // Keep only last 20 data points
            if (resourceData.length > 20) {
                resourceData.shift();
                requestData.shift();
            }
            
            // Update resource chart
            updateResourceChart();
            
            // Update request chart
            updateRequestChart();
        }

        // Update resource chart
        function updateResourceChart() {
            const chartDiv = document.getElementById('resource-chart');
            
            if (resourceData.length === 0) {
                chartDiv.innerHTML = '<div class="loading">No data available</div>';
                return;
            }
            
            let html = '<div style="min-height: 100%;">';
            
            resourceData.forEach((point, index) => {
                const isEven = index % 2 === 0;
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin: 0.25rem 0; background: ${isEven ? '#f7fafc' : '#ffffff'}; border-radius: 4px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.9rem; color: #4a5568; font-weight: 500;">${point.time}</span>
                        <div style="display: flex; gap: 1.5rem;">
                            <span style="color: #e53e3e; font-weight: 600; font-size: 0.9rem;">CPU: ${point.cpu.toFixed(1)}%</span>
                            <span style="color: #3182ce; font-weight: 600; font-size: 0.9rem;">Mem: ${point.memory.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        // Update request chart
        function updateRequestChart() {
            const chartDiv = document.getElementById('request-chart');
            
            if (requestData.length === 0) {
                chartDiv.innerHTML = '<div class="loading">No data available</div>';
                return;
            }
            
            let html = '<div style="min-height: 100%;">';
            
            requestData.forEach((point, index) => {
                const isEven = index % 2 === 0;
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin: 0.25rem 0; background: ${isEven ? '#f7fafc' : '#ffffff'}; border-radius: 4px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.9rem; color: #4a5568; font-weight: 500;">${point.time}</span>
                        <span style="color: #38a169; font-weight: 600; font-size: 0.9rem;">${point.requests} requests</span>
                    </div>
                `;
            });
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        // Utility functions
        function getValueClass(value, highThreshold, mediumThreshold) {
            if (value >= highThreshold) return 'high';
            if (value >= mediumThreshold) return 'medium';
            return 'low';
        }

        function getMostUsedModel(modelUsage) {
            if (!modelUsage || Object.keys(modelUsage).length === 0) {
                return 'None';
            }
            
            const entries = Object.entries(modelUsage);
            entries.sort((a, b) => b[1] - a[1]);
            return entries[0][0];
        }

        // Auto-refresh every 10 seconds
        setInterval(refreshAllData, 10000);

        // Load initial data
        refreshAllData();
    </script>
</body>
</html>
